<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Photographer - Professional Photography Assistant</title>
    <meta name="description" content="AI-powered photography assistant providing real-time camera settings, composition tips, and professional analysis for travel photographers.">
    <meta name="keywords" content="photography, AI, camera, travel, composition, analysis, professional">
    <meta name="author" content="AI Travel Photographer">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∏</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;overflow-x:hidden}.container{min-height:100vh;display:flex;flex-direction:column}.header{background:#000;padding:20px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}.header h1{margin:0;font-size:24px;font-weight:700}.header-buttons{display:flex;gap:12px}.header-btn{width:40px;height:40px;border-radius:20px;background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}.header-btn:hover{background:rgba(255,255,255,0.2)}.main-content{flex:1;padding:20px}.camera-section{background:#111;border-radius:16px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden}.camera-container{position:relative;width:100%;height:400px;background:#000;border-radius:12px;overflow:hidden}.video{width:100%;height:100%;object-fit:cover;border-radius:12px}.camera-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.8)}.camera-text{font-size:24px;font-weight:600;margin-bottom:8px}.camera-subtext{font-size:16px;opacity:0.7;text-align:center}.composition-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.vertical-line{position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.3)}.horizontal-line{position:absolute;left:0;right:0;height:1px;background:rgba(255,255,255,0.3)}.camera-status{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.8);padding:8px 12px;border-radius:20px;display:flex;align-items:center;gap:8px}.status-indicator{width:8px;height:8px;background:#4CAF50;border-radius:50%}.status-text{font-size:12px;font-weight:600}.camera-controls{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}.capture-button{width:65px;height:65px;border-radius:50%;background:#fff;border:3px solid #333;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;position:relative;flex-shrink:0}.capture-button:hover{transform:scale(1.05)}.capture-button-inner{width:45px;height:45px;border-radius:50%;background:#333}.control-button{width:40px;height:40px;border-radius:20px;background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;flex-shrink:0}.control-button:hover{background:rgba(255,255,255,0.2)}.ai-button{background:#007AFF;color:#fff;border:none;padding:6px 10px;border-radius:18px;cursor:pointer;display:flex;align-items:center;gap:4px;font-weight:600;transition:all 0.3s ease;font-size:11px;white-space:nowrap;flex-shrink:0}.ai-button:hover{background:#0056CC}.enhance-button{background:#FF6B6B;color:#fff;border:none;padding:6px 10px;border-radius:18px;cursor:pointer;display:flex;align-items:center;gap:4px;font-weight:600;transition:all 0.3s ease;font-size:11px;white-space:nowrap;flex-shrink:0}.enhance-button:hover{background:#E55A5A}.upload-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.8)}.upload-button{background:#4CAF50;color:#fff;border:none;padding:8px 12px;border-radius:20px;cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:600;transition:all 0.3s ease;font-size:12px}.upload-button:hover{background:#45A049}.uploaded-image-container{position:relative;width:100%;height:100%}.uploaded-image{width:100%;height:100%;object-fit:cover;border-radius:12px}.clear-image-button{position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:15px;background:rgba(255,0,0,0.8);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}.hidden-file-input{display:none}.analysis-panel{background:#111;border-radius:16px;padding:20px;margin-top:20px}.analysis-title{font-size:20px;font-weight:700;margin-bottom:16px;color:#007AFF}.analysis-section{margin-bottom:20px}.section-title{font-size:16px;font-weight:600;margin-bottom:8px;color:#4CAF50}.section-content{font-size:14px;line-height:1.5;opacity:0.9}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.analysis-item{background:rgba(255,255,255,0.05);padding:12px;border-radius:8px}.analysis-label{font-size:12px;opacity:0.7;margin-bottom:4px}.analysis-value{font-size:14px;font-weight:600}.tips-list{list-style:none;padding:0}.tips-list li{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}.tips-list li:last-child{border-bottom:none}.tips-list li:before{content:"üí°";margin-right:8px}.overall-score{text-align:center;padding:20px;background:rgba(0,122,255,0.1);border-radius:12px;margin-top:20px}.score-number{font-size:48px;font-weight:700;color:#007AFF;margin-bottom:8px}.score-label{font-size:16px;opacity:0.8}.instructions-container{background:rgba(0,122,255,0.1);padding:15px;margin:10px;border-radius:8px;border:1px solid #007AFF}.instructions-text{color:#007AFF;font-size:14px;font-weight:600;text-align:center}.enhancement-panel{background:#111;border-radius:16px;padding:20px;margin-top:20px;display:none}.enhancement-preview{display:flex;gap:20px;justify-content:center;align-items:center;flex-wrap:wrap}.preview-image{width:200px;height:150px;object-fit:cover;border-radius:8px;border:2px solid #333}.preview-label{text-align:center;font-size:12px;opacity:0.8;margin-top:8px}.download-button{background:#4CAF50;color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:600;margin-top:20px;display:block;margin-left:auto;margin-right:auto}.download-button:hover{background:#45A049}.auto-enhance-button{background:#FF6B6B;color:#fff;border:none;padding:12px 24px;border-radius:20px;cursor:pointer;font-weight:600;margin:20px auto;display:block;font-size:14px}.auto-enhance-button:hover{background:#E55A5A}.professional-tips{background:rgba(255,193,7,0.1);border:1px solid #FFC107;border-radius:8px;padding:15px;margin:10px 0}.professional-tips h4{color:#FFC107;margin-bottom:10px}.professional-tips ul{list-style:none;padding:0}.professional-tips li{padding:5px 0;border-bottom:1px solid rgba(255,193,7,0.2)}.professional-tips li:last-child{border-bottom:none}.professional-tips li:before{content:"‚≠ê";margin-right:8px}@media (max-width:768px){.header{padding:15px}.header h1{font-size:20px}.camera-container{height:300px}.capture-button{width:60px;height:60px}.capture-button-inner{width:40px;height:40px}.control-button{width:35px;height:35px}.ai-button{font-size:10px;padding:5px 8px}.enhance-button{font-size:10px;padding:5px 8px}.analysis-grid{grid-template-columns:1fr}.enhancement-preview{flex-direction:column}.preview-image{width:150px;height:100px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ AI Travel Photographer</h1>
            <div class="header-buttons">
                <button class="header-btn" id="cameraModeBtn" title="Camera Mode">üì∑</button>
                <button class="header-btn" id="uploadModeBtn" title="Upload Mode">üìÅ</button>
                <button class="header-btn" id="compositionBtn" title="Toggle Composition Overlay">‚äû</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Instructions -->
            <div class="instructions-container">
                <div class="instructions-text">
                    üì∏ Step 1: Click "Start Camera" ‚Üí Step 2: Allow permissions ‚Üí Step 3: Click capture button
                </div>
            </div>

            <!-- Camera/Upload Section -->
            <div class="camera-section">
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="camera-container">
                    <video id="videoElement" class="video" autoplay playsinline style="display: none;"></video>
                    
                    <div id="cameraPlaceholder" class="camera-placeholder">
                        <div style="font-size: 80px; margin-bottom: 16px;">üì∑</div>
                        <div class="camera-text">Camera Ready</div>
                        <div class="camera-subtext">Click "Start Camera" to begin</div>
                    </div>
                    
                    <div id="uploadPlaceholder" class="upload-placeholder" style="display: none;">
                        <div style="font-size: 80px; margin-bottom: 16px;">üìÅ</div>
                        <div class="camera-text">Upload Image</div>
                        <div class="camera-subtext">Click "Choose File" to upload an image for analysis</div>
                        <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                            üìÅ Choose File
                        </button>
                    </div>
                    
                    <div id="uploadedImageContainer" class="uploaded-image-container" style="display: none;">
                        <img id="uploadedImage" class="uploaded-image" alt="Uploaded for analysis">
                        <button class="clear-image-button" onclick="clearUploadedImage()">‚úï</button>
                    </div>
                    
                    <div id="compositionOverlay" class="composition-overlay" style="display: none;">
                        <div class="vertical-line" style="left: 33.33%;"></div>
                        <div class="vertical-line" style="left: 66.66%;"></div>
                        <div class="horizontal-line" style="top: 33.33%;"></div>
                        <div class="horizontal-line" style="top: 66.66%;"></div>
                    </div>
                    
                    <div id="cameraStatus" class="camera-status" style="display: none;">
                        <div class="status-indicator"></div>
                        <div class="status-text">Camera Active</div>
                    </div>
                </div>
                
                <div class="camera-controls">
                    <button id="startCameraBtn" class="control-button">üì∑</button>
                    <button id="captureBtn" class="capture-button">
                        <div class="capture-button-inner"></div>
                    </button>
                    <button id="stopCameraBtn" class="control-button">‚èπÔ∏è</button>
                    <button id="analyzeBtn" class="ai-button">‚ú® Analyze</button>
                    <button id="analyzeLastPhotoBtn" class="ai-button" style="background: #4CAF50; display: none;">‚ú® Last Photo</button>
                    <button id="enhanceBtn" class="enhance-button" style="display: none;">üé® Auto Enhance</button>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div id="analysisPanel" class="analysis-panel" style="display: none;">
                <div class="analysis-title">üìä AI Photography Analysis</div>
                <div id="analysisContent"></div>
            </div>

            <!-- Enhancement Panel -->
            <div id="enhancementPanel" class="enhancement-panel">
                <div class="analysis-title">üé® AI Photo Enhancement</div>
                <div class="enhancement-preview">
                    <div>
                        <img id="originalPreview" class="preview-image" alt="Original">
                        <div class="preview-label">Original</div>
                    </div>
                    <div>
                        <img id="enhancedPreview" class="preview-image" alt="Enhanced">
                        <div class="preview-label">AI Enhanced</div>
                    </div>
                </div>
                <button id="autoEnhanceBtn" class="auto-enhance-button">ü§ñ Apply AI Enhancement</button>
                <button id="downloadEnhancedBtn" class="download-button" style="display: none;">üì• Download Enhanced Photo</button>
            </div>
        </div>
    </div>

    <script>
        let cameraActive = false;
        let currentMode = 'camera';
        let uploadedImageData = null;
        let capturedPhotoData = null;
        let capturedPhotoUrl = null;
        let currentImageForEnhancement = null;

        const videoElement = document.getElementById('videoElement');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadedImageContainer = document.getElementById('uploadedImageContainer');
        const compositionOverlay = document.getElementById('compositionOverlay');
        const cameraStatus = document.getElementById('cameraStatus');
        const analysisPanel = document.getElementById('analysisPanel');
        const analysisContent = document.getElementById('analysisContent');
        const analyzeLastPhotoBtn = document.getElementById('analyzeLastPhotoBtn');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const enhancementPanel = document.getElementById('enhancementPanel');
        const originalPreview = document.getElementById('originalPreview');
        const enhancedPreview = document.getElementById('enhancedPreview');
        const downloadEnhancedBtn = document.getElementById('downloadEnhancedBtn');
        const autoEnhanceBtn = document.getElementById('autoEnhanceBtn');

        function setMode(mode) {
            currentMode = mode;
            
            if (mode === 'camera') {
                cameraPlaceholder.style.display = 'flex';
                uploadPlaceholder.style.display = 'none';
                uploadedImageContainer.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'flex';
                document.getElementById('captureBtn').style.display = 'flex';
                document.getElementById('stopCameraBtn').style.display = 'flex';
                document.getElementById('analyzeBtn').textContent = '‚ú® Analyze';
            } else {
                cameraPlaceholder.style.display = 'none';
                uploadPlaceholder.style.display = 'flex';
                uploadedImageContainer.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
                document.getElementById('analyzeBtn').textContent = '‚ú® Analyze';
            }
        }

        async function startCamera() {
            try {
                console.log('üé• Starting camera...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                cameraStatus.style.display = 'flex';
                cameraActive = true;
                
                console.log('‚úÖ Camera started successfully');
                
            } catch (error) {
                console.error('‚ùå Camera error:', error);
                alert('Camera access denied. Please allow camera permissions and try again.');
            }
        }

        function stopCamera() {
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            videoElement.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            cameraStatus.style.display = 'none';
            cameraActive = false;
        }

        function capturePhoto() {
            if (!cameraActive || !videoElement.srcObject) {
                alert('Please start the camera first!');
                return;
            }

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0);
            
            canvas.toBlob((blob) => {
                if (blob) {
                    capturedPhotoData = blob;
                    capturedPhotoUrl = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = capturedPhotoUrl;
                    a.download = `ai-photo-${Date.now()}.jpg`;
                    a.click();
                    
                    analyzeLastPhotoBtn.style.display = 'flex';
                    enhanceBtn.style.display = 'flex';
                    
                    console.log('üì∏ Photo captured and saved!');
                    alert('Photo captured! Click "Last Photo" for detailed analysis or "Auto Enhance" for AI improvements.');
                }
            }, 'image/jpeg', 0.9);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageData = e.target.result;
                    document.getElementById('uploadedImage').src = uploadedImageData;
                    uploadPlaceholder.style.display = 'none';
                    uploadedImageContainer.style.display = 'block';
                    enhanceBtn.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearUploadedImage() {
            uploadedImageData = null;
            uploadPlaceholder.style.display = 'flex';
            uploadedImageContainer.style.display = 'none';
            enhanceBtn.style.display = 'none';
        }

        function toggleComposition() {
            const isVisible = compositionOverlay.style.display !== 'none';
            compositionOverlay.style.display = isVisible ? 'none' : 'block';
        }

        async function analyzeImageProperties(imageBlob) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    let totalBrightness = 0;
                    let totalRed = 0, totalGreen = 0, totalBlue = 0;
                    let darkPixels = 0, brightPixels = 0;
                    let edgePixels = 0;
                    
                    // Advanced analysis
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        const brightness = (r + g + b) / 3;
                        totalBrightness += brightness;
                        totalRed += r;
                        totalGreen += g;
                        totalBlue += b;
                        
                        if (brightness < 85) darkPixels++;
                        if (brightness > 170) brightPixels++;
                        
                        // Edge detection for sharpness
                        if (i > 0 && i < data.length - 4) {
                            const prevBrightness = (data[i-4] + data[i-3] + data[i-2]) / 3;
                            if (Math.abs(brightness - prevBrightness) > 30) edgePixels++;
                        }
                    }
                    
                    const pixelCount = data.length / 4;
                    const avgBrightness = totalBrightness / pixelCount;
                    const avgRed = totalRed / pixelCount;
                    const avgGreen = totalGreen / pixelCount;
                    const avgBlue = totalBlue / pixelCount;
                    
                    // Calculate advanced metrics
                    let contrastSum = 0;
                    let colorVariance = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        contrastSum += Math.abs(brightness - avgBrightness);
                        
                        const colorDistance = Math.sqrt(
                            Math.pow(data[i] - avgRed, 2) + 
                            Math.pow(data[i + 1] - avgGreen, 2) + 
                            Math.pow(data[i + 2] - avgBlue, 2)
                        );
                        colorVariance += colorDistance;
                    }
                    
                    const contrast = contrastSum / pixelCount;
                    const colorDiversity = colorVariance / pixelCount;
                    const sharpness = (edgePixels / pixelCount) * 100;
                    const exposureBalance = Math.abs(avgBrightness - 128) / 128;
                    
                    // Advanced lighting analysis
                    let lightingCondition = 'Balanced lighting';
                    let lightingQuality = 'Good';
                    let colorTemperature = 'Daylight (5500K)';
                    let lightingScore = 80;
                    
                    if (avgBrightness < 80) {
                        lightingCondition = 'Very low light conditions';
                        lightingQuality = 'Poor - needs significant improvement';
                        colorTemperature = 'Warm (3000K)';
                        lightingScore = 30;
                    } else if (avgBrightness < 120) {
                        lightingCondition = 'Low light conditions';
                        lightingQuality = 'Fair - could be improved';
                        colorTemperature = 'Warm (4000K)';
                        lightingScore = 60;
                    } else if (avgBrightness > 220) {
                        lightingCondition = 'Overexposed/bright conditions';
                        lightingQuality = 'Poor - too bright';
                        colorTemperature = 'Cool (6500K)';
                        lightingScore = 40;
                    } else if (avgBrightness > 180) {
                        lightingCondition = 'Bright conditions';
                        lightingQuality = 'Good but bright';
                        colorTemperature = 'Cool (6000K)';
                        lightingScore = 70;
                    }
                    
                    // Advanced composition analysis
                    const aspectRatio = img.width / img.height;
                    let compositionScore = 70;
                    let hasDepth = true;
                    let framingScore = 75;
                    let balanceScore = 70;
                    let symmetryScore = 60;
                    let ruleOfThirdsScore = 50;
                    
                    // Aspect ratio analysis
                    if (aspectRatio > 2.0 || aspectRatio < 0.5) {
                        compositionScore -= 15; // Very wide or tall
                    } else if (aspectRatio > 1.5 || aspectRatio < 0.7) {
                        compositionScore -= 10; // Wide or tall
                    }
                    
                    // Contrast and depth analysis
                    if (contrast < 20) {
                        compositionScore -= 20; // Very low contrast
                        hasDepth = false;
                    } else if (contrast < 30) {
                        compositionScore -= 15; // Low contrast
                        hasDepth = false;
                    } else if (contrast > 60) {
                        compositionScore += 10; // High contrast
                    }
                    
                    // Color analysis
                    if (colorDiversity > 50) {
                        compositionScore += 5; // Good color diversity
                    }
                    
                    // Sharpness analysis
                    if (sharpness > 15) {
                        compositionScore += 10; // Very sharp
                    } else if (sharpness > 10) {
                        compositionScore += 5; // Sharp
                    } else if (sharpness < 5) {
                        compositionScore -= 10; // Blurry
                    }
                    
                    // Exposure analysis
                    if (exposureBalance < 0.1) {
                        compositionScore += 10; // Well exposed
                    } else if (exposureBalance > 0.3) {
                        compositionScore -= 15; // Poorly exposed
                    }
                    
                    // Genre detection with more accuracy
                    let detectedGenre = 'General Photography';
                    let genreConfidence = 60;
                    
                    if (avgBrightness > 180 && contrast > 50 && sharpness > 10) {
                        detectedGenre = 'Portrait Photography';
                        genreConfidence = 85;
                    } else if (aspectRatio > 1.3 && colorDiversity > 40) {
                        detectedGenre = 'Landscape Photography';
                        genreConfidence = 80;
                    } else if (avgBrightness < 120 && contrast < 40) {
                        detectedGenre = 'Low Light Photography';
                        genreConfidence = 75;
                    } else if (sharpness > 15 && contrast > 60) {
                        detectedGenre = 'Street Photography';
                        genreConfidence = 70;
                    } else if (colorDiversity > 60 && avgBrightness > 150) {
                        detectedGenre = 'Nature Photography';
                        genreConfidence = 75;
                    }
                    
                    // Generate comprehensive recommendations
                    const recommendations = [];
                    const specificTips = [];
                    const professionalTips = [];
                    
                    // Technical recommendations
                    if (avgBrightness < 100) {
                        recommendations.push('Increase exposure by 1-2 stops');
                        specificTips.push('Try increasing camera exposure or using flash');
                        professionalTips.push('Consider using a faster lens (f/1.4-f/2.8) or increasing ISO');
                    }
                    if (contrast < 30) {
                        recommendations.push('Improve contrast in post-processing');
                        specificTips.push('Adjust lighting or post-processing contrast');
                        professionalTips.push('Use graduated filters or HDR techniques');
                    }
                    if (sharpness < 8) {
                        recommendations.push('Improve focus and sharpness');
                        specificTips.push('Check focus settings and camera stability');
                        professionalTips.push('Use tripod, faster shutter speed, or image stabilization');
                    }
                    if (compositionScore < 70) {
                        recommendations.push('Improve composition');
                        specificTips.push('Use rule of thirds, try different angles');
                        professionalTips.push('Consider leading lines, framing, and negative space');
                    }
                    if (exposureBalance > 0.2) {
                        recommendations.push('Adjust exposure settings');
                        specificTips.push('Use exposure compensation');
                        professionalTips.push('Use spot metering for better exposure control');
                    }
                    
                    // Positive feedback
                    if (recommendations.length === 0) {
                        recommendations.push('Excellent technical quality');
                        specificTips.push('Try different compositions for variety');
                        professionalTips.push('Consider experimenting with different lighting conditions');
                    }
                    
                    // Calculate comprehensive overall score
                    const technicalScore = Math.min(100, 
                        (lightingScore * 0.3) + 
                        (Math.min(100, contrast * 2) * 0.2) + 
                        (Math.min(100, sharpness * 5) * 0.2) + 
                        (Math.max(0, 100 - exposureBalance * 200) * 0.3)
                    );
                    
                    const overallScore = Math.round(
                        (technicalScore * 0.4) + 
                        (compositionScore * 0.4) + 
                        (genreConfidence * 0.2)
                    );
                    
                    // Determine quality level
                    let overallQuality = 'Good';
                    if (overallScore >= 90) overallQuality = 'Exceptional';
                    else if (overallScore >= 80) overallQuality = 'Excellent';
                    else if (overallScore >= 70) overallQuality = 'Good';
                    else if (overallScore >= 60) overallQuality = 'Fair';
                    else if (overallScore >= 50) overallQuality = 'Needs Improvement';
                    else overallQuality = 'Poor';
                    
                    // Generate comprehensive strengths and improvements
                    const strengths = [];
                    const improvements = [];
                    
                    if (overallScore >= 85) strengths.push('Exceptional technical quality');
                    if (contrast > 40) strengths.push('Good contrast and dynamic range');
                    if (avgBrightness > 100 && avgBrightness < 200) strengths.push('Proper exposure');
                    if (compositionScore > 80) strengths.push('Excellent composition');
                    if (sharpness > 12) strengths.push('Sharp and detailed');
                    if (colorDiversity > 50) strengths.push('Rich color palette');
                    
                    if (overallScore < 70) improvements.push('Improve overall technical quality');
                    if (contrast < 30) improvements.push('Increase contrast and dynamic range');
                    if (avgBrightness < 100) improvements.push('Better lighting and exposure needed');
                    if (compositionScore < 70) improvements.push('Work on composition and framing');
                    if (sharpness < 8) improvements.push('Improve focus and sharpness');
                    if (exposureBalance > 0.2) improvements.push('Better exposure control needed');
                    
                    resolve({
                        lightingCondition,
                        lightingQuality,
                        colorTemperature,
                        brightness: Math.round(avgBrightness),
                        contrast: Math.round(contrast),
                        sharpness: Math.round(sharpness),
                        colorDiversity: Math.round(colorDiversity),
                        exposureBalance: Math.round(exposureBalance * 100),
                        compositionScore,
                        hasDepth,
                        framingScore,
                        balanceScore,
                        symmetryScore,
                        ruleOfThirdsScore,
                        detectedGenre,
                        genreConfidence,
                        recommendations,
                        specificTips,
                        professionalTips,
                        overallScore,
                        overallQuality,
                        technicalScore: Math.round(technicalScore),
                        strengths,
                        improvements,
                    });
                };
                
                img.src = URL.createObjectURL(imageBlob);
            });
        }

        async function extractImageMetadata(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const basicMetadata = {
                        resolution: `${img.naturalWidth}x${img.naturalHeight}`,
                        aspectRatio: (img.naturalWidth / img.naturalHeight).toFixed(2),
                        megapixels: ((img.naturalWidth * img.naturalHeight) / 1000000).toFixed(1),
                        fileSize: file.size ? `${(file.size / 1024).toFixed(1)} KB` : 'Unknown',
                        fileType: file.type || 'image/jpeg',
                        fileName: file.name || 'captured-photo.jpg',
                        lastModified: file.lastModified ? new Date(file.lastModified).toLocaleString() : new Date().toLocaleString(),
                    };

                    EXIF.getData(img, function() {
                        const exifData = {
                            aperture: EXIF.getTag(this, 'FNumber') ? `f/${EXIF.getTag(this, 'FNumber')}` : 'Not available',
                            shutterSpeed: EXIF.getTag(this, 'ExposureTime') ? `1/${Math.round(1/EXIF.getTag(this, 'ExposureTime'))}s` : 'Not available',
                            iso: EXIF.getTag(this, 'ISOSpeedRatings') || 'Not available',
                            focalLength: EXIF.getTag(this, 'FocalLength') ? `${EXIF.getTag(this, 'FocalLength')}mm` : 'Not available',
                            exposureCompensation: EXIF.getTag(this, 'ExposureBiasValue') ? `${EXIF.getTag(this, 'ExposureBiasValue')} EV` : 'Not available',
                            whiteBalance: EXIF.getTag(this, 'WhiteBalance') === 1 ? 'Auto' : 'Manual',
                            meteringMode: EXIF.getTag(this, 'MeteringMode') ? EXIF.getTag(this, 'MeteringMode') : 'Not available',
                            focusMode: EXIF.getTag(this, 'FocusMode') ? EXIF.getTag(this, 'FocusMode') : 'Not available',
                            cameraMake: EXIF.getTag(this, 'Make') || 'Web Camera',
                            cameraModel: EXIF.getTag(this, 'Model') || 'Browser Camera',
                            dateTaken: EXIF.getTag(this, 'DateTime') || new Date().toISOString(),
                            flash: EXIF.getTag(this, 'Flash') ? 'Used' : 'Not used',
                            lensModel: EXIF.getTag(this, 'LensModel') || 'Not available',
                        };

                        resolve({ ...basicMetadata, ...exifData });
                    });
                };
                img.src = URL.createObjectURL(file);
            });
        }

        async function analyzeCapturedPhoto() {
            if (!capturedPhotoData) {
                alert('No captured photo available. Please capture a photo first.');
                return;
            }

            try {
                const file = new File([capturedPhotoData], 'captured-photo.jpg', { type: 'image/jpeg' });
                const metadata = await extractImageMetadata(file);
                const imageAnalysis = await analyzeImageProperties(capturedPhotoData);
                
                const analysis = {
                    technical: {
                        resolution: metadata.resolution,
                        aspectRatio: metadata.aspectRatio,
                        megapixels: metadata.megapixels,
                        fileSize: metadata.fileSize,
                        fileType: metadata.fileType,
                        fileName: metadata.fileName,
                        lastModified: metadata.lastModified,
                        aperture: metadata.aperture,
                        shutterSpeed: metadata.shutterSpeed,
                        iso: metadata.iso,
                        focalLength: metadata.focalLength,
                        exposureCompensation: metadata.exposureCompensation,
                        whiteBalance: metadata.whiteBalance,
                        meteringMode: metadata.meteringMode,
                        focusMode: metadata.focusMode,
                        cameraMake: metadata.cameraMake,
                        cameraModel: metadata.cameraModel,
                        dateTaken: metadata.dateTaken,
                        flash: metadata.flash,
                        lensModel: metadata.lensModel,
                    },
                    lighting: {
                        condition: imageAnalysis.lightingCondition,
                        quality: imageAnalysis.lightingQuality,
                        colorTemp: imageAnalysis.colorTemperature,
                        brightness: imageAnalysis.brightness,
                        contrast: imageAnalysis.contrast,
                        sharpness: imageAnalysis.sharpness,
                        colorDiversity: imageAnalysis.colorDiversity,
                        exposureBalance: imageAnalysis.exposureBalance,
                    },
                    composition: {
                        ruleOfThirds: imageAnalysis.compositionScore > 70 ? 'Good composition' : 'Consider rule of thirds',
                        depth: imageAnalysis.hasDepth ? 'Good depth perception' : 'Try adding depth',
                        framing: imageAnalysis.compositionScore > 75 ? 'Well-framed' : 'Consider better framing',
                        balance: imageAnalysis.compositionScore > 70 ? 'Good balance' : 'Try improving balance',
                        score: imageAnalysis.compositionScore,
                        ruleOfThirdsScore: imageAnalysis.ruleOfThirdsScore,
                    },
                    settings: {
                        current: `Resolution: ${metadata.resolution}, File Size: ${metadata.fileSize}, Quality: ${imageAnalysis.overallQuality}`,
                        recommended: imageAnalysis.recommendations.join(', '),
                        reasoning: `Based on comprehensive analysis of ${metadata.resolution} image with ${imageAnalysis.overallQuality} quality`,
                    },
                    tips: imageAnalysis.specificTips,
                    professionalTips: imageAnalysis.professionalTips,
                    overall: {
                        score: imageAnalysis.overallScore,
                        technicalScore: imageAnalysis.technicalScore,
                        genre: imageAnalysis.detectedGenre,
                        genreConfidence: imageAnalysis.genreConfidence,
                        strengths: imageAnalysis.strengths,
                        improvements: imageAnalysis.improvements,
                        timestamp: new Date().toISOString(),
                    },
                };
                
                updateAnalysisPanel(analysis);
                alert(`Comprehensive analysis complete! Overall Score: ${imageAnalysis.overallScore}/100, Technical Score: ${imageAnalysis.technicalScore}/100`);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Failed to analyze photo. Please try again.');
            }
        }

        async function analyzeUploadedImage() {
            if (!uploadedImageData) {
                alert('Please upload an image first.');
                return;
            }

            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) return;

                const metadata = await extractImageMetadata(file);
                const imageAnalysis = await analyzeImageProperties(file);
                
                const analysis = {
                    technical: {
                        resolution: metadata.resolution,
                        aspectRatio: metadata.aspectRatio,
                        megapixels: metadata.megapixels,
                        fileSize: metadata.fileSize,
                        fileType: metadata.fileType,
                        fileName: metadata.fileName,
                        lastModified: metadata.lastModified,
                        aperture: metadata.aperture,
                        shutterSpeed: metadata.shutterSpeed,
                        iso: metadata.iso,
                        focalLength: metadata.focalLength,
                        exposureCompensation: metadata.exposureCompensation,
                        whiteBalance: metadata.whiteBalance,
                        meteringMode: metadata.meteringMode,
                        focusMode: metadata.focusMode,
                        cameraMake: metadata.cameraMake,
                        cameraModel: metadata.cameraModel,
                        dateTaken: metadata.dateTaken,
                        flash: metadata.flash,
                        lensModel: metadata.lensModel,
                    },
                    lighting: {
                        condition: imageAnalysis.lightingCondition,
                        quality: imageAnalysis.lightingQuality,
                        colorTemp: imageAnalysis.colorTemperature,
                        brightness: imageAnalysis.brightness,
                        contrast: imageAnalysis.contrast,
                        sharpness: imageAnalysis.sharpness,
                        colorDiversity: imageAnalysis.colorDiversity,
                        exposureBalance: imageAnalysis.exposureBalance,
                    },
                    composition: {
                        ruleOfThirds: imageAnalysis.compositionScore > 70 ? 'Good composition' : 'Consider rule of thirds',
                        depth: imageAnalysis.hasDepth ? 'Good depth perception' : 'Try adding depth',
                        framing: imageAnalysis.compositionScore > 75 ? 'Well-framed' : 'Consider better framing',
                        balance: imageAnalysis.compositionScore > 70 ? 'Good balance' : 'Try improving balance',
                        score: imageAnalysis.compositionScore,
                        ruleOfThirdsScore: imageAnalysis.ruleOfThirdsScore,
                    },
                    settings: {
                        current: `Resolution: ${metadata.resolution}, File Size: ${metadata.fileSize}, Quality: ${imageAnalysis.overallQuality}`,
                        recommended: imageAnalysis.recommendations.join(', '),
                        reasoning: `Based on comprehensive analysis of ${metadata.resolution} image with ${imageAnalysis.overallQuality} quality`,
                    },
                    tips: imageAnalysis.specificTips,
                    professionalTips: imageAnalysis.professionalTips,
                    overall: {
                        score: imageAnalysis.overallScore,
                        technicalScore: imageAnalysis.technicalScore,
                        genre: imageAnalysis.detectedGenre,
                        genreConfidence: imageAnalysis.genreConfidence,
                        strengths: imageAnalysis.strengths,
                        improvements: imageAnalysis.improvements,
                        timestamp: new Date().toISOString(),
                    },
                };
                
                updateAnalysisPanel(analysis);
                alert(`Comprehensive analysis complete! Overall Score: ${imageAnalysis.overallScore}/100, Technical Score: ${imageAnalysis.technicalScore}/100`);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Failed to analyze image. Please try again.');
            }
        }

        function analyzeScene() {
            const mockAnalysis = {
                technical: {
                    resolution: '1280x720',
                    aspectRatio: '1.78',
                    megapixels: '0.9',
                    fileSize: 'Unknown',
                    fileType: 'Live Camera Feed',
                    fileName: 'Live Feed',
                    lastModified: new Date().toLocaleString(),
                    aperture: 'Not available',
                    shutterSpeed: 'Not available',
                    iso: 'Not available',
                    focalLength: 'Not available',
                    exposureCompensation: 'Not available',
                    whiteBalance: 'Auto',
                    meteringMode: 'Not available',
                    focusMode: 'Auto',
                    cameraMake: 'Web Camera',
                    cameraModel: 'Browser Camera',
                    dateTaken: new Date().toISOString(),
                    flash: 'Not used',
                    lensModel: 'Not available',
                },
                lighting: {
                    condition: 'Live scene analysis',
                    quality: 'Good',
                    colorTemp: 'Daylight (5500K)',
                    brightness: 'Balanced',
                    contrast: 'Good',
                    sharpness: 'Live feed',
                    colorDiversity: 'Good',
                    exposureBalance: 'Balanced',
                },
                composition: {
                    ruleOfThirds: 'Consider applying rule of thirds for better composition',
                    depth: 'Good depth of field',
                    framing: 'Well-framed subject',
                    balance: 'Good balance',
                    score: 75,
                    ruleOfThirdsScore: 60,
                },
                settings: {
                    current: 'Live camera feed - 1280x720 resolution',
                    recommended: 'Consider adjusting exposure for optimal results',
                    reasoning: 'Based on live scene analysis',
                },
                tips: [
                    'Try different angles for more dynamic shots',
                    'Consider using composition overlays',
                    'Experiment with different lighting conditions',
                ],
                professionalTips: [
                    'Use manual focus for better control',
                    'Consider using a tripod for stability',
                    'Experiment with different aperture settings',
                ],
                overall: {
                    score: 75,
                    technicalScore: 70,
                    genre: 'Live Photography',
                    genreConfidence: 60,
                    strengths: ['Good technical quality', 'Clear image capture', 'Proper exposure'],
                    improvements: ['Try different compositions', 'Experiment with angles', 'Consider lighting variations'],
                    timestamp: new Date().toISOString(),
                },
            };
            
            updateAnalysisPanel(mockAnalysis);
            alert('Live scene analysis complete! Check the comprehensive analysis panel below.');
        }

        function updateAnalysisPanel(analysis) {
            analysisContent.innerHTML = `
                <div class="overall-score">
                    <div class="score-number">${analysis.overall.score}</div>
                    <div class="score-label">Overall Score / 100</div>
                    <div style="margin-top: 8px; font-size: 14px; opacity: 0.8;">
                        Technical: ${analysis.overall.technicalScore}/100 | 
                        Genre: ${analysis.overall.genre} (${analysis.overall.genreConfidence}% confidence)
                    </div>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-section">
                        <div class="section-title">üìä Technical Details</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Resolution</div>
                            <div class="analysis-value">${analysis.technical.resolution}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Aspect Ratio</div>
                            <div class="analysis-value">${analysis.technical.aspectRatio}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Megapixels</div>
                            <div class="analysis-value">${analysis.technical.megapixels} MP</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">File Size</div>
                            <div class="analysis-value">${analysis.technical.fileSize}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Camera</div>
                            <div class="analysis-value">${analysis.technical.cameraMake} ${analysis.technical.cameraModel}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Aperture</div>
                            <div class="analysis-value">${analysis.technical.aperture}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Shutter Speed</div>
                            <div class="analysis-value">${analysis.technical.shutterSpeed}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">ISO</div>
                            <div class="analysis-value">${analysis.technical.iso}</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">üí° Advanced Lighting Analysis</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Condition</div>
                            <div class="analysis-value">${analysis.lighting.condition}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Quality</div>
                            <div class="analysis-value">${analysis.lighting.quality}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Color Temperature</div>
                            <div class="analysis-value">${analysis.lighting.colorTemp}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Brightness</div>
                            <div class="analysis-value">${analysis.lighting.brightness}/255</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Contrast</div>
                            <div class="analysis-value">${analysis.lighting.contrast}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Sharpness</div>
                            <div class="analysis-value">${analysis.lighting.sharpness}%</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Color Diversity</div>
                            <div class="analysis-value">${analysis.lighting.colorDiversity}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Exposure Balance</div>
                            <div class="analysis-value">${analysis.lighting.exposureBalance}%</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">üé® Composition Analysis</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Overall Score</div>
                            <div class="analysis-value">${analysis.composition.score}/100</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Rule of Thirds</div>
                            <div class="analysis-value">${analysis.composition.ruleOfThirds}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Depth</div>
                            <div class="analysis-value">${analysis.composition.depth}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Framing</div>
                            <div class="analysis-value">${analysis.composition.framing}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Balance</div>
                            <div class="analysis-value">${analysis.composition.balance}</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">‚öôÔ∏è Settings & Recommendations</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Current</div>
                            <div class="analysis-value">${analysis.settings.current}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Recommended</div>
                            <div class="analysis-value">${analysis.settings.recommended}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Reasoning</div>
                            <div class="analysis-value">${analysis.settings.reasoning}</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <div class="section-title">üí° Photography Tips</div>
                    <ul class="tips-list">
                        ${analysis.tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>

                <div class="professional-tips">
                    <h4>‚≠ê Professional Recommendations</h4>
                    <ul>
                        ${analysis.professionalTips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>

                <div class="analysis-section">
                    <div class="section-title">‚úÖ Strengths</div>
                    <ul class="tips-list">
                        ${analysis.overall.strengths.map(strength => `<li>${strength}</li>`).join('')}
                    </ul>
                </div>

                <div class="analysis-section">
                    <div class="section-title">üîß Improvements</div>
                    <ul class="tips-list">
                        ${analysis.overall.improvements.map(improvement => `<li>${improvement}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            analysisPanel.style.display = 'block';
        }

        function showEnhancementPanel() {
            const imageData = capturedPhotoData || uploadedImageData;
            if (!imageData) {
                alert('No image available for enhancement. Please capture or upload a photo first.');
                return;
            }

            currentImageForEnhancement = imageData;
            originalPreview.src = imageData;
            enhancedPreview.src = imageData;
            enhancementPanel.style.display = 'block';
            downloadEnhancedBtn.style.display = 'none';
        }

        function applyAutoEnhancement() {
            if (!currentImageForEnhancement) return;

            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Analyze image to determine optimal enhancements
                let totalBrightness = 0;
                let totalContrast = 0;
                let colorVariance = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const brightness = (r + g + b) / 3;
                    totalBrightness += brightness;
                    
                    // Calculate local contrast
                    if (i > 0 && i < data.length - 4) {
                        const prevBrightness = (data[i-4] + data[i-3] + data[i-2]) / 3;
                        totalContrast += Math.abs(brightness - prevBrightness);
                    }
                    
                    // Calculate color variance
                    const avgColor = (r + g + b) / 3;
                    colorVariance += Math.sqrt((r - avgColor) ** 2 + (g - avgColor) ** 2 + (b - avgColor) ** 2);
                }
                
                const pixelCount = data.length / 4;
                const avgBrightness = totalBrightness / pixelCount;
                const avgContrast = totalContrast / pixelCount;
                const avgColorVariance = colorVariance / pixelCount;
                
                // Determine optimal enhancement values based on analysis
                let brightnessAdjust = 0;
                let contrastAdjust = 0;
                let saturationAdjust = 0;
                let sharpnessAdjust = 0;
                
                // Brightness optimization
                if (avgBrightness < 100) {
                    brightnessAdjust = Math.min(30, (100 - avgBrightness) * 0.3);
                } else if (avgBrightness > 200) {
                    brightnessAdjust = Math.max(-20, (100 - avgBrightness) * 0.2);
                }
                
                // Contrast enhancement
                if (avgContrast < 20) {
                    contrastAdjust = Math.min(25, (20 - avgContrast) * 1.2);
                } else if (avgContrast > 40) {
                    contrastAdjust = Math.max(-10, (40 - avgContrast) * 0.5);
                }
                
                // Saturation enhancement
                if (avgColorVariance < 30) {
                    saturationAdjust = Math.min(20, (30 - avgColorVariance) * 0.7);
                }
                
                // Sharpness enhancement
                if (avgContrast < 25) {
                    sharpnessAdjust = Math.min(30, (25 - avgContrast) * 1.2);
                }
                
                console.log(`ü§ñ Auto-enhancement: Brightness +${brightnessAdjust}, Contrast +${contrastAdjust}, Saturation +${saturationAdjust}, Sharpness +${sharpnessAdjust}`);
                
                // Apply enhancements
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];
                    
                    // Brightness adjustment
                    r += brightnessAdjust;
                    g += brightnessAdjust;
                    b += brightnessAdjust;
                    
                    // Contrast adjustment
                    const contrastFactor = (259 * (contrastAdjust + 255)) / (255 * (259 - contrastAdjust));
                    r = contrastFactor * (r - 128) + 128;
                    g = contrastFactor * (g - 128) + 128;
                    b = contrastFactor * (b - 128) + 128;
                    
                    // Saturation adjustment
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    const saturationFactor = (saturationAdjust + 100) / 100;
                    r = gray + saturationFactor * (r - gray);
                    g = gray + saturationFactor * (g - gray);
                    b = gray + saturationFactor * (b - gray);
                    
                    // Clamp values
                    data[i] = Math.max(0, Math.min(255, r));
                    data[i + 1] = Math.max(0, Math.min(255, g));
                    data[i + 2] = Math.max(0, Math.min(255, b));
                }
                
                // Apply sharpening if needed
                if (sharpnessAdjust > 0) {
                    const sharpeningKernel = [
                        0, -sharpnessAdjust/100, 0,
                        -sharpnessAdjust/100, 1 + 4*sharpnessAdjust/100, -sharpnessAdjust/100,
                        0, -sharpnessAdjust/100, 0
                    ];
                    
                    const tempData = new Uint8ClampedArray(data);
                    for (let y = 1; y < canvas.height - 1; y++) {
                        for (let x = 1; x < canvas.width - 1; x++) {
                            const idx = (y * canvas.width + x) * 4;
                            
                            let r = 0, g = 0, b = 0;
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const kidx = ((y + ky) * canvas.width + (x + kx)) * 4;
                                    const kernelIdx = (ky + 1) * 3 + (kx + 1);
                                    r += tempData[kidx] * sharpeningKernel[kernelIdx];
                                    g += tempData[kidx + 1] * sharpeningKernel[kernelIdx];
                                    b += tempData[kidx + 2] * sharpeningKernel[kernelIdx];
                                }
                            }
                            
                            data[idx] = Math.max(0, Math.min(255, r));
                            data[idx + 1] = Math.max(0, Math.min(255, g));
                            data[idx + 2] = Math.max(0, Math.min(255, b));
                        }
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                canvas.toBlob((blob) => {
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        enhancedPreview.src = url;
                        downloadEnhancedBtn.style.display = 'block';
                        downloadEnhancedBtn.onclick = () => {
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `ai-enhanced-photo-${Date.now()}.jpg`;
                            a.click();
                        };
                        
                        alert(`ü§ñ AI Enhancement Complete!\n\nApplied optimizations:\n‚Ä¢ Brightness: ${brightnessAdjust > 0 ? '+' : ''}${brightnessAdjust}\n‚Ä¢ Contrast: ${contrastAdjust > 0 ? '+' : ''}${contrastAdjust}\n‚Ä¢ Saturation: ${saturationAdjust > 0 ? '+' : ''}${saturationAdjust}\n‚Ä¢ Sharpness: ${sharpnessAdjust > 0 ? '+' : ''}${sharpnessAdjust}\n\nDownload your enhanced photo!`);
                    }
                }, 'image/jpeg', 0.9);
            };
            
            img.src = currentImageForEnhancement;
        }

        // Event Listeners
        document.getElementById('cameraModeBtn').addEventListener('click', () => setMode('camera'));
        document.getElementById('uploadModeBtn').addEventListener('click', () => setMode('upload'));
        document.getElementById('compositionBtn').addEventListener('click', toggleComposition);
        document.getElementById('startCameraBtn').addEventListener('click', startCamera);
        document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
        document.getElementById('captureBtn').addEventListener('click', capturePhoto);
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            if (currentMode === 'camera') {
                analyzeScene();
            } else {
                analyzeUploadedImage();
            }
        });
        document.getElementById('analyzeLastPhotoBtn').addEventListener('click', analyzeCapturedPhoto);
        document.getElementById('enhanceBtn').addEventListener('click', showEnhancementPanel);
        document.getElementById('autoEnhanceBtn').addEventListener('click', applyAutoEnhancement);
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    </script>
</body>
</html>