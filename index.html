<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Photographer - Professional Photography Assistant</title>
    <meta name="description" content="AI-powered photography assistant providing real-time camera settings, composition tips, and professional analysis for travel photographers.">
    <meta name="keywords" content="photography, AI, camera, travel, composition, analysis, professional">
    <meta name="author" content="AI Travel Photographer">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∏</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;overflow-x:hidden}.container{min-height:100vh;display:flex;flex-direction:column}.header{background:#000;padding:20px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}.header h1{margin:0;font-size:24px;font-weight:700}.header-buttons{display:flex;gap:12px}.header-btn{width:40px;height:40px;border-radius:20px;background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}.header-btn:hover{background:rgba(255,255,255,0.2)}.main-content{flex:1;padding:20px}.camera-section{background:#111;border-radius:16px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden}.camera-container{position:relative;width:100%;height:400px;background:#000;border-radius:12px;overflow:hidden}.video{width:100%;height:100%;object-fit:cover;border-radius:12px}.camera-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.8)}.camera-text{font-size:24px;font-weight:600;margin-bottom:8px}.camera-subtext{font-size:16px;opacity:0.7;text-align:center}.composition-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.vertical-line{position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.3)}.horizontal-line{position:absolute;left:0;right:0;height:1px;background:rgba(255,255,255,0.3)}.camera-status{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.8);padding:8px 12px;border-radius:20px;display:flex;align-items:center;gap:8px;z-index:5}.status-indicator{width:8px;height:8px;background:#4CAF50;border-radius:50%}.status-text{font-size:12px;font-weight:600}.camera-controls{display:flex;justify-content:center;align-items:center;gap:20px;margin-top:20px}.capture-button{width:80px;height:80px;border-radius:50%;background:#fff;border:4px solid #333;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;position:relative}.capture-button:hover{transform:scale(1.05)}.capture-button-inner{width:60px;height:60px;border-radius:50%;background:#333}.control-button{width:50px;height:50px;border-radius:25px;background:rgba(255,255,255,0.1);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}.control-button:hover{background:rgba(255,255,255,0.2)}.ai-button{background:#007AFF;color:#fff;border:none;padding:12px 20px;border-radius:25px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;transition:all 0.3s ease}.ai-button:hover{background:#0056CC}.upload-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.8)}.upload-button{background:#4CAF50;color:#fff;border:none;padding:12px 20px;border-radius:25px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;transition:all 0.3s ease}.upload-button:hover{background:#45A049}.uploaded-image-container{position:relative;width:100%;height:100%}.uploaded-image{width:100%;height:100%;object-fit:cover;border-radius:12px}.clear-image-button{position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:15px;background:rgba(255,0,0,0.8);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}.hidden-file-input{display:none}.analysis-panel{background:#111;border-radius:16px;padding:20px;margin-top:20px}.analysis-title{font-size:20px;font-weight:700;margin-bottom:16px;color:#007AFF}.analysis-section{margin-bottom:20px}.section-title{font-size:16px;font-weight:600;margin-bottom:8px;color:#4CAF50}.section-content{font-size:14px;line-height:1.5;opacity:0.9}.analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.analysis-item{background:rgba(255,255,255,0.05);padding:12px;border-radius:8px}.analysis-label{font-size:12px;opacity:0.7;margin-bottom:4px}.analysis-value{font-size:14px;font-weight:600}.tips-list{list-style:none;padding:0}.tips-list li{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)}.tips-list li:last-child{border-bottom:none}.tips-list li:before{content:"üí°";margin-right:8px}.overall-score{text-align:center;padding:20px;background:rgba(0,122,255,0.1);border-radius:12px;margin-top:20px}.score-number{font-size:48px;font-weight:700;color:#007AFF;margin-bottom:8px}.score-label{font-size:16px;opacity:0.8}.debug-info{background:rgba(0,0,0,0.8);padding:10px;margin:10px;border-radius:8px;font-family:monospace;font-size:12px;color:#00FF00}.instructions-container{background:rgba(0,122,255,0.1);padding:15px;margin:10px;border-radius:8px;border:1px solid #007AFF}.instructions-text{color:#007AFF;font-size:14px;font-weight:600;text-align:center}.photo-score-overlay{position:absolute;top:0;right:0;width:280px;height:100%;background:rgba(0,0,0,0.9);backdrop-filter:blur(10px);border-left:1px solid rgba(255,255,255,0.1);padding:20px;display:flex;flex-direction:column;overflow-y:auto;z-index:10}.score-overlay-header{margin-bottom:20px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:15px}.score-overlay-title{font-size:20px;font-weight:700;color:#007AFF;margin-bottom:4px}.score-overlay-subtitle{font-size:12px;opacity:0.7;color:#fff}.score-overlay-main{margin-bottom:24px;text-align:center}.live-score-circle{position:relative;width:120px;height:120px;margin:0 auto 12px;border-radius:50%;background:linear-gradient(135deg,#007AFF 0%,#4CAF50 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,122,255,0.3)}.live-score-number{font-size:36px;font-weight:700;color:#fff;line-height:1}.live-score-label{font-size:14px;opacity:0.9;color:#fff;margin-top:4px}.score-quality-badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;background:rgba(255,255,255,0.1);color:#fff}.score-overlay-details{margin-bottom:20px}.score-detail-item{margin-bottom:16px}.score-detail-label{font-size:12px;opacity:0.8;margin-bottom:6px;display:flex;align-items:center;gap:6px}.score-detail-value{font-size:16px;font-weight:600;color:#007AFF;margin-bottom:6px}.score-detail-bar{width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden}.score-detail-bar-fill{height:100%;background:linear-gradient(90deg,#007AFF,#4CAF50);border-radius:3px;transition:width 0.3s ease}.score-overlay-tips{background:rgba(0,122,255,0.1);padding:12px;border-radius:8px;border:1px solid rgba(0,122,255,0.3)}.score-tips-title{font-size:13px;font-weight:600;color:#007AFF;margin-bottom:8px}.score-tips-content{font-size:12px;line-height:1.5;opacity:0.9;color:#fff}@media (max-width:768px){.header{padding:15px}.header h1{font-size:20px}.camera-container{height:300px}.capture-button{width:70px;height:70px}.capture-button-inner{width:50px;height:50px}.analysis-grid{grid-template-columns:1fr}.photo-score-overlay{width:240px;padding:15px}.live-score-circle{width:100px;height:100px}.live-score-number{font-size:30px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ AI Travel Photographer</h1>
            <div class="header-buttons">
                <button class="header-btn" id="cameraModeBtn" title="Camera Mode">üì∑</button>
                <button class="header-btn" id="uploadModeBtn" title="Upload Mode">üìÅ</button>
                <button class="header-btn" id="compositionBtn" title="Toggle Composition Overlay">‚äû</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Debug Info -->
            <div id="debugInfo" class="debug-info">
                <div style="color: #00FF00; font-family: monospace; font-size: 12px;">
                    Debug: Camera Active: NO<br>
                    Analysis Mode: camera<br>
                    Uploaded Image: NO
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions-container">
                <div class="instructions-text">
                    üì∏ Step 1: Click "Start Camera" ‚Üí Step 2: Allow permissions ‚Üí Step 3: Click capture button
                </div>
            </div>

            <!-- Camera/Upload Section -->
            <div class="camera-section">
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="camera-container">
                    <video id="videoElement" class="video" autoplay playsinline style="display: none;"></video>
                    
                    <div id="cameraPlaceholder" class="camera-placeholder">
                        <div style="font-size: 80px; margin-bottom: 16px;">üì∑</div>
                        <div class="camera-text">Camera Ready</div>
                        <div class="camera-subtext">Click "Start Camera" to begin</div>
                    </div>
                    
                    <div id="uploadPlaceholder" class="upload-placeholder" style="display: none;">
                        <div style="font-size: 80px; margin-bottom: 16px;">üìÅ</div>
                        <div class="camera-text">Upload Image</div>
                        <div class="camera-subtext">Click "Choose File" to upload an image for analysis</div>
                        <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                            üìÅ Choose File
                        </button>
                    </div>
                    
                    <div id="uploadedImageContainer" class="uploaded-image-container" style="display: none;">
                        <img id="uploadedImage" class="uploaded-image" alt="Uploaded for analysis">
                        <button class="clear-image-button" onclick="clearUploadedImage()">‚úï</button>
                    </div>
                    
                    <div id="compositionOverlay" class="composition-overlay" style="display: none;">
                        <div class="vertical-line" style="left: 33.33%;"></div>
                        <div class="vertical-line" style="left: 66.66%;"></div>
                        <div class="horizontal-line" style="top: 33.33%;"></div>
                        <div class="horizontal-line" style="top: 66.66%;"></div>
                    </div>
                    
                    <div id="cameraStatus" class="camera-status" style="display: none;">
                        <div class="status-indicator"></div>
                        <div class="status-text">Camera Active</div>
                    </div>
                    
                    <!-- Real-time Photo Score Overlay -->
                    <div id="photoScoreOverlay" class="photo-score-overlay" style="display: none;">
                        <div class="score-overlay-header">
                            <div class="score-overlay-title">üì∏ Live Score</div>
                            <div class="score-overlay-subtitle">Real-time Analysis</div>
                        </div>
                        <div class="score-overlay-main">
                            <div class="live-score-circle">
                                <div class="live-score-number" id="liveScoreNumber">--</div>
                                <div class="live-score-label">/ 100</div>
                            </div>
                            <div class="score-quality-badge" id="scoreQualityBadge">Analyzing...</div>
                        </div>
                        <div class="score-overlay-details">
                            <div class="score-detail-item">
                                <div class="score-detail-label">üí° Lighting</div>
                                <div class="score-detail-value" id="liveLighting">--</div>
                                <div class="score-detail-bar">
                                    <div class="score-detail-bar-fill" id="liveLightingBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-label">üé® Composition</div>
                                <div class="score-detail-value" id="liveComposition">--</div>
                                <div class="score-detail-bar">
                                    <div class="score-detail-bar-fill" id="liveCompositionBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-label">‚ú® Brightness</div>
                                <div class="score-detail-value" id="liveBrightness">--</div>
                                <div class="score-detail-bar">
                                    <div class="score-detail-bar-fill" id="liveBrightnessBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-label">‚ö° Contrast</div>
                                <div class="score-detail-value" id="liveContrast">--</div>
                                <div class="score-detail-bar">
                                    <div class="score-detail-bar-fill" id="liveContrastBar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-label">üéØ Sharpness</div>
                                <div class="score-detail-value" id="liveSharpness">--</div>
                                <div class="score-detail-bar">
                                    <div class="score-detail-bar-fill" id="liveSharpnessBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="score-overlay-tips">
                            <div class="score-tips-title">üí° Quick Tips</div>
                            <div class="score-tips-content" id="liveTips">Position your subject and wait for analysis...</div>
                        </div>
                    </div>
                </div>
                
                <div class="camera-controls">
                    <button id="startCameraBtn" class="control-button">üì∑ Start Camera</button>
                    <button id="captureBtn" class="capture-button">
                        <div class="capture-button-inner"></div>
                    </button>
                    <button id="stopCameraBtn" class="control-button">‚èπÔ∏è Stop</button>
                    <button id="analyzeBtn" class="ai-button">‚ú® Analyze Scene</button>
                    <button id="analyzeLastPhotoBtn" class="ai-button" style="background: #4CAF50; display: none;">‚ú® Analyze Last Photo</button>
                </div>
            </div>

            <!-- Analysis Panel -->
            <div id="analysisPanel" class="analysis-panel" style="display: none;">
                <div class="analysis-title">üìä AI Photography Analysis</div>
                <div id="analysisContent"></div>
            </div>
        </div>
    </div>

    <script>
        let cameraActive = false;
        let currentMode = 'camera';
        let uploadedImageData = null;
        let capturedPhotoData = null;
        let capturedPhotoUrl = null;

        const videoElement = document.getElementById('videoElement');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadedImageContainer = document.getElementById('uploadedImageContainer');
        const compositionOverlay = document.getElementById('compositionOverlay');
        const cameraStatus = document.getElementById('cameraStatus');
        const analysisPanel = document.getElementById('analysisPanel');
        const analysisContent = document.getElementById('analysisContent');
        const analyzeLastPhotoBtn = document.getElementById('analyzeLastPhotoBtn');
        const photoScoreOverlay = document.getElementById('photoScoreOverlay');
        
        let realTimeAnalysisInterval = null;
        let isAnalyzing = false;

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = `
                    <div style="color: #00FF00; font-family: monospace; font-size: 12px;">
                        Debug: Camera Active: ${cameraActive ? 'YES' : 'NO'}<br>
                        Analysis Mode: ${currentMode}<br>
                        Uploaded Image: ${uploadedImageData ? 'YES' : 'NO'}<br>
                        Captured Photo: ${capturedPhotoData ? 'YES' : 'NO'}
                    </div>
                `;
            }
        }

        function setMode(mode) {
            currentMode = mode;
            updateDebugInfo();
            
            if (mode === 'camera') {
                cameraPlaceholder.style.display = 'flex';
                uploadPlaceholder.style.display = 'none';
                uploadedImageContainer.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'flex';
                document.getElementById('captureBtn').style.display = 'flex';
                document.getElementById('stopCameraBtn').style.display = 'flex';
                document.getElementById('analyzeBtn').textContent = '‚ú® Analyze Scene';
            } else {
                cameraPlaceholder.style.display = 'none';
                uploadPlaceholder.style.display = 'flex';
                uploadedImageContainer.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
                document.getElementById('analyzeBtn').textContent = '‚ú® Analyze Image';
            }
        }

        async function startCamera() {
            try {
                console.log('üé• Starting camera...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                cameraStatus.style.display = 'flex';
                cameraActive = true;
                
                // Show and start real-time overlay
                photoScoreOverlay.style.display = 'flex';
                startRealTimeAnalysis();
                
                console.log('‚úÖ Camera started successfully');
                updateDebugInfo();
                
            } catch (error) {
                console.error('‚ùå Camera error:', error);
                alert('Camera access denied. Please allow camera permissions and try again.');
            }
        }

        function stopCamera() {
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            videoElement.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            cameraStatus.style.display = 'none';
            cameraActive = false;
            
            // Hide and stop real-time overlay
            photoScoreOverlay.style.display = 'none';
            stopRealTimeAnalysis();
            
            updateDebugInfo();
        }

        function capturePhoto() {
            if (!cameraActive || !videoElement.srcObject) {
                alert('Please start the camera first!');
                return;
            }

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0);
            
            canvas.toBlob((blob) => {
                if (blob) {
                    capturedPhotoData = blob;
                    capturedPhotoUrl = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = capturedPhotoUrl;
                    a.download = `ai-photo-${Date.now()}.jpg`;
                    a.click();
                    
                    analyzeLastPhotoBtn.style.display = 'flex';
                    updateDebugInfo();
                    
                    console.log('üì∏ Photo captured and saved!');
                    alert('Photo captured! Click "Analyze Last Photo" for detailed analysis.');
                }
            }, 'image/jpeg', 0.9);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageData = e.target.result;
                    document.getElementById('uploadedImage').src = uploadedImageData;
                    uploadPlaceholder.style.display = 'none';
                    uploadedImageContainer.style.display = 'block';
                    updateDebugInfo();
                };
                reader.readAsDataURL(file);
            }
        }

        function clearUploadedImage() {
            uploadedImageData = null;
            uploadPlaceholder.style.display = 'flex';
            uploadedImageContainer.style.display = 'none';
            updateDebugInfo();
        }

        function toggleComposition() {
            const isVisible = compositionOverlay.style.display !== 'none';
            compositionOverlay.style.display = isVisible ? 'none' : 'block';
        }

        // Advanced photography analysis functions
        function analyzeHistogram(imageData) {
            const data = imageData.data;
            const histogram = {
                r: new Array(256).fill(0),
                g: new Array(256).fill(0),
                b: new Array(256).fill(0),
                luminance: new Array(256).fill(0)
            };
            
            for (let i = 0; i < data.length; i += 16) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const luminance = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                
                histogram.r[r]++;
                histogram.g[g]++;
                histogram.b[b]++;
                histogram.luminance[luminance]++;
            }
            
            // Find peaks and valleys
            let maxLum = 0, minLum = 255;
            let totalLum = 0, lumCount = 0;
            for (let i = 0; i < 256; i++) {
                if (histogram.luminance[i] > 0) {
                    if (i < minLum) minLum = i;
                    if (i > maxLum) maxLum = i;
                    totalLum += i * histogram.luminance[i];
                    lumCount += histogram.luminance[i];
                }
            }
            
            const avgLuminance = lumCount > 0 ? totalLum / lumCount : 128;
            const dynamicRange = maxLum - minLum;
            
            // Check for clipping (over/under exposure)
            const shadowClipping = histogram.luminance.slice(0, 5).reduce((a, b) => a + b, 0);
            const highlightClipping = histogram.luminance.slice(250, 256).reduce((a, b) => a + b, 0);
            const totalPixels = lumCount;
            const shadowClipPercent = (shadowClipping / totalPixels) * 100;
            const highlightClipPercent = (highlightClipping / totalPixels) * 100;
            
            return {
                histogram,
                avgLuminance,
                dynamicRange,
                shadowClipPercent,
                highlightClipPercent,
                minLum,
                maxLum
            };
        }

        function analyzeSharpness(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            let edgeStrength = 0;
            let edgeCount = 0;
            
            // Sobel edge detection (simplified for performance)
            for (let y = 1; y < height - 1; y += 2) {
                for (let x = 1; x < width - 1; x += 2) {
                    const idx = (y * width + x) * 4;
                    const idxRight = (y * width + (x + 1)) * 4;
                    const idxBottom = ((y + 1) * width + x) * 4;
                    
                    const lum1 = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                    const lum2 = 0.299 * data[idxRight] + 0.587 * data[idxRight + 1] + 0.114 * data[idxRight + 2];
                    const lum3 = 0.299 * data[idxBottom] + 0.587 * data[idxBottom + 1] + 0.114 * data[idxBottom + 2];
                    
                    const edgeX = Math.abs(lum1 - lum2);
                    const edgeY = Math.abs(lum1 - lum3);
                    const edge = Math.sqrt(edgeX * edgeX + edgeY * edgeY);
                    
                    if (edge > 15) { // Threshold for edge detection
                        edgeStrength += edge;
                        edgeCount++;
                    }
                }
            }
            
            const avgEdgeStrength = edgeCount > 0 ? edgeStrength / edgeCount : 0;
            const sharpnessScore = Math.min(100, Math.round((avgEdgeStrength / 50) * 100));
            
            return {
                sharpnessScore,
                avgEdgeStrength,
                edgeCount
            };
        }

        function analyzeComposition(imageData, width, height) {
            const data = imageData.data;
            const thirdWidth = width / 3;
            const thirdHeight = height / 3;
            
            // Rule of thirds: Analyze interest points at intersection lines
            const intersections = [
                { x: thirdWidth, y: thirdHeight },
                { x: thirdWidth * 2, y: thirdHeight },
                { x: thirdWidth, y: thirdHeight * 2 },
                { x: thirdWidth * 2, y: thirdHeight * 2 }
            ];
            
            // Calculate visual weight at rule-of-thirds intersections
            let intersectionInterest = 0;
            const radius = 20;
            
            intersections.forEach(point => {
                let totalContrast = 0;
                let samples = 0;
                
                for (let dy = -radius; dy <= radius; dy += 4) {
                    for (let dx = -radius; dx <= radius; dx += 4) {
                        const x = Math.round(point.x + dx);
                        const y = Math.round(point.y + dy);
                        
                        if (x >= 0 && x < width && y >= 0 && y < height) {
                            const idx = (y * width + x) * 4;
                            const idxRight = (y * width + Math.min(width - 1, x + 1)) * 4;
                            const idxBottom = ((Math.min(height - 1, y + 1)) * width + x) * 4;
                            
                            const lum1 = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                            const lum2 = 0.299 * data[idxRight] + 0.587 * data[idxRight + 1] + 0.114 * data[idxRight + 2];
                            const lum3 = 0.299 * data[idxBottom] + 0.587 * data[idxBottom + 1] + 0.114 * data[idxBottom + 2];
                            
                            totalContrast += Math.abs(lum1 - lum2) + Math.abs(lum1 - lum3);
                            samples++;
                        }
                    }
                }
                
                if (samples > 0) {
                    intersectionInterest += totalContrast / samples;
                }
            });
            
            intersectionInterest /= intersections.length;
            
            // Horizon detection (for landscape photos)
            let horizontalSymmetry = 0;
            if (width > height * 1.2) { // Landscape orientation
                const midY = Math.floor(height / 2);
                let topAvg = 0, bottomAvg = 0, topCount = 0, bottomCount = 0;
                
                for (let y = 0; y < height; y += 2) {
                    for (let x = 0; x < width; x += 2) {
                        const idx = (y * width + x) * 4;
                        const lum = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                        
                        if (y < midY) {
                            topAvg += lum;
                            topCount++;
                        } else {
                            bottomAvg += lum;
                            bottomCount++;
                        }
                    }
                }
                
                if (topCount > 0 && bottomCount > 0) {
                    topAvg /= topCount;
                    bottomAvg /= bottomCount;
                    horizontalSymmetry = 100 - Math.abs(topAvg - bottomAvg) / 2.55;
                }
            }
            
            // Subject-background separation (center vs edges)
            const centerX = width / 2;
            const centerY = height / 2;
            const centerRadius = Math.min(width, height) * 0.3;
            
            let centerBrightness = 0, edgeBrightness = 0;
            let centerCount = 0, edgeCount = 0;
            
            for (let y = 0; y < height; y += 3) {
                for (let x = 0; x < width; x += 3) {
                    const idx = (y * width + x) * 4;
                    const lum = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                    const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                    
                    if (dist < centerRadius) {
                        centerBrightness += lum;
                        centerCount++;
                    } else if (dist > centerRadius * 2) {
                        edgeBrightness += lum;
                        edgeCount++;
                    }
                }
            }
            
            let separation = 0;
            if (centerCount > 0 && edgeCount > 0) {
                centerBrightness /= centerCount;
                edgeBrightness /= edgeCount;
                separation = Math.min(100, Math.abs(centerBrightness - edgeBrightness) / 2.55);
            }
            
            // Calculate composition score
            let compositionScore = 60;
            
            // Rule of thirds bonus
            if (intersectionInterest > 25) {
                compositionScore += 15;
            }
            
            // Horizon level bonus
            if (horizontalSymmetry > 85) {
                compositionScore += 10;
            }
            
            // Subject-background separation
            if (separation > 20) {
                compositionScore += 15;
            }
            
            compositionScore = Math.min(100, compositionScore);
            
            return {
                compositionScore,
                ruleOfThirds: intersectionInterest > 20,
                horizonLevel: horizontalSymmetry > 85,
                subjectSeparation: separation > 15,
                separation
            };
        }

        function analyzeColor(imageData) {
            const data = imageData.data;
            let totalHue = 0, totalSaturation = 0, totalValue = 0;
            let pixelCount = 0;
            
            // Analyze color distribution
            const colorZones = {
                red: 0, orange: 0, yellow: 0, green: 0, blue: 0, purple: 0
            };
            
            for (let i = 0; i < data.length; i += 16) {
                const r = data[i] / 255;
                const g = data[i + 1] / 255;
                const b = data[i + 2] / 255;
                
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                const delta = max - min;
                
                let hue = 0;
                if (delta !== 0) {
                    if (max === r) {
                        hue = ((g - b) / delta) % 6;
                    } else if (max === g) {
                        hue = (b - r) / delta + 2;
                    } else {
                        hue = (r - g) / delta + 4;
                    }
                    hue *= 60;
                    if (hue < 0) hue += 360;
                }
                
                const saturation = max === 0 ? 0 : delta / max;
                const value = max;
                
                totalHue += hue;
                totalSaturation += saturation;
                totalValue += value;
                pixelCount++;
                
                // Color zone classification
                if (hue >= 0 && hue < 30) colorZones.red++;
                else if (hue >= 30 && hue < 60) colorZones.orange++;
                else if (hue >= 60 && hue < 90) colorZones.yellow++;
                else if (hue >= 90 && hue < 150) colorZones.green++;
                else if (hue >= 150 && hue < 270) colorZones.blue++;
                else colorZones.purple++;
            }
            
            const avgHue = totalHue / pixelCount;
            const avgSaturation = (totalSaturation / pixelCount) * 100;
            const avgValue = (totalValue / pixelCount) * 100;
            
            // Calculate color harmony score
            const dominantColor = Object.entries(colorZones).reduce((a, b) => 
                colorZones[a[0]] > colorZones[b[0]] ? a : b
            )[0];
            
            // Saturation score (good photos often have balanced saturation)
            let saturationScore = 70;
            if (avgSaturation > 40 && avgSaturation < 80) {
                saturationScore = 90;
            } else if (avgSaturation < 20) {
                saturationScore = 50; // Too desaturated
            } else if (avgSaturation > 90) {
                saturationScore = 60; // Oversaturated
            }
            
            return {
                avgSaturation,
                saturationScore,
                colorBalance: avgSaturation > 30 && avgSaturation < 85,
                dominantColor
            };
        }

        function analyzeVideoFrame() {
            if (!cameraActive || !videoElement.srcObject || videoElement.readyState !== videoElement.HAVE_ENOUGH_DATA) {
                return null;
            }

            try {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // Use optimized resolution for analysis
                const scale = 0.4;
                canvas.width = Math.floor(videoElement.videoWidth * scale);
                canvas.height = Math.floor(videoElement.videoHeight * scale);
                
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 1. HISTOGRAM ANALYSIS
                const histAnalysis = analyzeHistogram(imageData);
                
                // 2. SHARPNESS/FOCUS ANALYSIS
                const sharpness = analyzeSharpness(imageData);
                
                // 3. COMPOSITION ANALYSIS
                const composition = analyzeComposition(imageData, canvas.width, canvas.height);
                
                // 4. COLOR ANALYSIS
                const color = analyzeColor(imageData);
                
                // Calculate detailed scores
                
                // LIGHTING SCORE (based on histogram and exposure)
                let lightingScore = 70;
                let lightingQuality = 'Good';
                
                if (histAnalysis.shadowClipPercent > 5 || histAnalysis.highlightClipPercent > 5) {
                    lightingScore = 50;
                    lightingQuality = 'Clipping Detected';
                } else if (histAnalysis.dynamicRange < 100) {
                    lightingScore = 60;
                    lightingQuality = 'Low Dynamic Range';
                } else if (histAnalysis.avgLuminance < 70) {
                    lightingScore = 50;
                    lightingQuality = 'Under-exposed';
                } else if (histAnalysis.avgLuminance > 200) {
                    lightingScore = 65;
                    lightingQuality = 'Over-exposed';
                } else if (histAnalysis.avgLuminance >= 100 && histAnalysis.avgLuminance <= 180 && histAnalysis.dynamicRange > 150) {
                    lightingScore = 90;
                    lightingQuality = 'Excellent';
                } else if (histAnalysis.avgLuminance >= 80 && histAnalysis.avgLuminance <= 200) {
                    lightingScore = 80;
                    lightingQuality = 'Good';
                }
                
                // BRIGHTNESS SCORE (based on histogram)
                let brightnessScore = 70;
                const optimalBrightness = 128;
                const brightnessDiff = Math.abs(histAnalysis.avgLuminance - optimalBrightness);
                brightnessScore = Math.max(0, Math.min(100, 100 - (brightnessDiff / 127) * 30));
                
                // CONTRAST SCORE (based on dynamic range and histogram spread)
                let contrastScore = 70;
                if (histAnalysis.dynamicRange > 180) {
                    contrastScore = 90;
                } else if (histAnalysis.dynamicRange > 140) {
                    contrastScore = 80;
                } else if (histAnalysis.dynamicRange > 100) {
                    contrastScore = 70;
                } else if (histAnalysis.dynamicRange > 60) {
                    contrastScore = 55;
                } else {
                    contrastScore = 40;
                }
                
                // TECHNICAL QUALITY SCORE (sharpness + color)
                const technicalScore = Math.round((sharpness.sharpnessScore * 0.6) + (color.saturationScore * 0.4));
                
                // Overall score using professional photography weights
                const overallScore = Math.round(
                    (lightingScore * 0.25) +      // Lighting is crucial
                    (composition.compositionScore * 0.25) +  // Composition is crucial
                    (brightnessScore * 0.15) +   // Proper exposure
                    (contrastScore * 0.15) +     // Contrast for visual interest
                    (technicalScore * 0.2)      // Technical quality (sharpness, color)
                );
                
                // Determine quality badge
                let qualityBadge = 'Good';
                if (overallScore >= 85) qualityBadge = 'Excellent';
                else if (overallScore >= 70) qualityBadge = 'Good';
                else if (overallScore >= 55) qualityBadge = 'Fair';
                else qualityBadge = 'Needs Work';
                
                // Generate contextual tips based on analysis
                const tips = [];
                
                if (histAnalysis.shadowClipPercent > 5) {
                    tips.push('üî¶ Increase exposure - shadows are clipped');
                } else if (histAnalysis.highlightClipPercent > 5) {
                    tips.push('‚òÄÔ∏è Reduce exposure - highlights are blown');
                } else if (histAnalysis.avgLuminance < 70) {
                    tips.push('üí° Increase brightness or add light');
                } else if (histAnalysis.avgLuminance > 200) {
                    tips.push('üåÖ Reduce exposure or dim lights');
                }
                
                if (contrastScore < 60) {
                    tips.push('‚ö° Improve contrast - more dynamic range needed');
                }
                
                if (sharpness.sharpnessScore < 60) {
                    tips.push('üéØ Focus on your subject - image appears soft');
                }
                
                if (!composition.ruleOfThirds && composition.compositionScore < 70) {
                    tips.push('üìê Apply rule of thirds - position subject at intersection');
                }
                
                if (!composition.subjectSeparation && composition.separation < 15) {
                    tips.push('üé® Separate subject from background');
                }
                
                if (!color.colorBalance) {
                    if (color.avgSaturation < 30) {
                        tips.push('üåà Increase color saturation');
                    } else {
                        tips.push('üé® Reduce saturation - colors look oversaturated');
                    }
                }
                
                if (tips.length === 0) {
                    tips.push('‚ú® Excellent! Ready to capture the perfect shot');
                }
                
                return {
                    overallScore,
                    qualityBadge,
                    lightingScore,
                    lightingQuality,
                    compositionScore: composition.compositionScore,
                    brightnessScore,
                    contrastScore,
                    technicalScore,
                    sharpness: sharpness.sharpnessScore,
                    colorScore: color.saturationScore,
                    tips: tips[0],
                    // Additional insights for detailed view
                    insights: {
                        dynamicRange: histAnalysis.dynamicRange,
                        ruleOfThirds: composition.ruleOfThirds,
                        sharp: sharpness.sharpnessScore > 70,
                        colorHarmony: color.colorBalance
                    }
                };
                
            } catch (error) {
                console.error('Frame analysis error:', error);
                return null;
            }
        }

        function updateLiveOverlay(analysis) {
            if (!analysis) return;
            
            // Update score
            document.getElementById('liveScoreNumber').textContent = analysis.overallScore;
            
            // Update quality badge
            const badge = document.getElementById('scoreQualityBadge');
            badge.textContent = analysis.qualityBadge;
            if (analysis.overallScore >= 85) {
                badge.style.background = 'rgba(76, 175, 80, 0.3)';
                badge.style.color = '#4CAF50';
            } else if (analysis.overallScore >= 70) {
                badge.style.background = 'rgba(0, 122, 255, 0.3)';
                badge.style.color = '#007AFF';
            } else if (analysis.overallScore >= 55) {
                badge.style.background = 'rgba(255, 152, 0, 0.3)';
                badge.style.color = '#FF9800';
            } else {
                badge.style.background = 'rgba(244, 67, 54, 0.3)';
                badge.style.color = '#F44336';
            }
            
            // Update detail values and bars
            document.getElementById('liveLighting').textContent = analysis.lightingQuality;
            document.getElementById('liveLightingBar').style.width = `${analysis.lightingScore}%`;
            
            document.getElementById('liveComposition').textContent = `${analysis.compositionScore}/100`;
            document.getElementById('liveCompositionBar').style.width = `${analysis.compositionScore}%`;
            
            document.getElementById('liveBrightness').textContent = `${analysis.brightnessScore}/100`;
            document.getElementById('liveBrightnessBar').style.width = `${analysis.brightnessScore}%`;
            
            document.getElementById('liveContrast').textContent = `${analysis.contrastScore}/100`;
            document.getElementById('liveContrastBar').style.width = `${analysis.contrastScore}%`;
            
            // Update sharpness if available
            if (analysis.sharpness !== undefined) {
                document.getElementById('liveSharpness').textContent = `${analysis.sharpness}/100`;
                document.getElementById('liveSharpnessBar').style.width = `${analysis.sharpness}%`;
            } else {
                document.getElementById('liveSharpness').textContent = '--';
                document.getElementById('liveSharpnessBar').style.width = '0%';
            }
            
            // Update tips
            document.getElementById('liveTips').textContent = analysis.tips;
        }

        function startRealTimeAnalysis() {
            // Wait for video to be ready
            if (realTimeAnalysisInterval) {
                clearInterval(realTimeAnalysisInterval);
            }
            
            // Initial delay to let video start
            setTimeout(() => {
                // Analyze every 500ms for smooth updates
                realTimeAnalysisInterval = setInterval(() => {
                    if (cameraActive && videoElement.srcObject) {
                        const analysis = analyzeVideoFrame();
                        if (analysis) {
                            updateLiveOverlay(analysis);
                        }
                    }
                }, 500);
            }, 1000);
        }

        function stopRealTimeAnalysis() {
            if (realTimeAnalysisInterval) {
                clearInterval(realTimeAnalysisInterval);
                realTimeAnalysisInterval = null;
            }
        }

        async function analyzeImageProperties(imageBlob) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    let totalBrightness = 0;
                    let totalRed = 0, totalGreen = 0, totalBlue = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        const brightness = (r + g + b) / 3;
                        totalBrightness += brightness;
                        totalRed += r;
                        totalGreen += g;
                        totalBlue += b;
                    }
                    
                    const pixelCount = data.length / 4;
                    const avgBrightness = totalBrightness / pixelCount;
                    const avgRed = totalRed / pixelCount;
                    const avgGreen = totalGreen / pixelCount;
                    const avgBlue = totalBlue / pixelCount;
                    
                    let contrastSum = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        contrastSum += Math.abs(brightness - avgBrightness);
                    }
                    const contrast = contrastSum / pixelCount;
                    
                    let lightingCondition = 'Balanced lighting';
                    let lightingQuality = 'Good';
                    let colorTemperature = 'Daylight (5500K)';
                    
                    if (avgBrightness < 100) {
                        lightingCondition = 'Low light conditions';
                        lightingQuality = 'Needs improvement';
                        colorTemperature = 'Warm (3000K)';
                    } else if (avgBrightness > 200) {
                        lightingCondition = 'Bright/overexposed';
                        lightingQuality = 'Too bright';
                        colorTemperature = 'Cool (6500K)';
                    }
                    
                    const aspectRatio = img.width / img.height;
                    let compositionScore = 70;
                    let hasDepth = true;
                    
                    if (aspectRatio > 1.5 || aspectRatio < 0.7) {
                        compositionScore -= 10;
                    }
                    
                    if (contrast < 30) {
                        compositionScore -= 15;
                        hasDepth = false;
                    }
                    
                    let detectedGenre = 'General Photography';
                    if (avgBrightness > 180 && contrast > 50) {
                        detectedGenre = 'Portrait Photography';
                    } else if (aspectRatio > 1.3) {
                        detectedGenre = 'Landscape Photography';
                    } else if (avgBrightness < 120) {
                        detectedGenre = 'Low Light Photography';
                    }
                    
                    const recommendations = [];
                    const specificTips = [];
                    
                    if (avgBrightness < 100) {
                        recommendations.push('Increase exposure');
                        specificTips.push('Try increasing camera exposure or using flash');
                    }
                    if (contrast < 30) {
                        recommendations.push('Improve contrast');
                        specificTips.push('Adjust lighting or post-processing contrast');
                    }
                    if (compositionScore < 70) {
                        recommendations.push('Improve composition');
                        specificTips.push('Use rule of thirds, try different angles');
                    }
                    if (recommendations.length === 0) {
                        recommendations.push('Good technical quality');
                        specificTips.push('Try different compositions for variety');
                    }
                    
                    const overallScore = Math.round(
                        compositionScore + 
                        (lightingQuality === 'Good' ? 20 : 10) + 
                        (contrast > 40 ? 10 : 0) + 
                        (avgBrightness > 100 && avgBrightness < 200 ? 10 : 0)
                    );
                    
                    let overallQuality = 'Good';
                    if (overallScore >= 85) overallQuality = 'Excellent';
                    else if (overallScore >= 70) overallQuality = 'Good';
                    else if (overallScore >= 55) overallQuality = 'Fair';
                    else overallQuality = 'Needs Improvement';
                    
                    const strengths = [];
                    const improvements = [];
                    
                    if (overallScore >= 80) strengths.push('Excellent technical quality');
                    if (contrast > 40) strengths.push('Good contrast');
                    if (avgBrightness > 100 && avgBrightness < 200) strengths.push('Proper exposure');
                    if (compositionScore > 75) strengths.push('Good composition');
                    
                    if (overallScore < 70) improvements.push('Improve overall quality');
                    if (contrast < 30) improvements.push('Increase contrast');
                    if (avgBrightness < 100) improvements.push('Better lighting needed');
                    if (compositionScore < 70) improvements.push('Work on composition');
                    
                    resolve({
                        lightingCondition,
                        lightingQuality,
                        colorTemperature,
                        brightness: Math.round(avgBrightness),
                        contrast: Math.round(contrast),
                        compositionScore,
                        hasDepth,
                        detectedGenre,
                        recommendations,
                        specificTips,
                        overallScore,
                        overallQuality,
                        strengths,
                        improvements,
                    });
                };
                
                img.src = URL.createObjectURL(imageBlob);
            });
        }

        async function extractImageMetadata(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const basicMetadata = {
                        resolution: `${img.naturalWidth}x${img.naturalHeight}`,
                        aspectRatio: (img.naturalWidth / img.naturalHeight).toFixed(2),
                        megapixels: ((img.naturalWidth * img.naturalHeight) / 1000000).toFixed(1),
                        fileSize: file.size ? `${(file.size / 1024).toFixed(1)} KB` : 'Unknown',
                        fileType: file.type || 'image/jpeg',
                        fileName: file.name || 'captured-photo.jpg',
                        lastModified: file.lastModified ? new Date(file.lastModified).toLocaleString() : new Date().toLocaleString(),
                    };

                    EXIF.getData(img, function() {
                        const exifData = {
                            aperture: EXIF.getTag(this, 'FNumber') ? `f/${EXIF.getTag(this, 'FNumber')}` : 'Not available',
                            shutterSpeed: EXIF.getTag(this, 'ExposureTime') ? `1/${Math.round(1/EXIF.getTag(this, 'ExposureTime'))}s` : 'Not available',
                            iso: EXIF.getTag(this, 'ISOSpeedRatings') || 'Not available',
                            focalLength: EXIF.getTag(this, 'FocalLength') ? `${EXIF.getTag(this, 'FocalLength')}mm` : 'Not available',
                            exposureCompensation: EXIF.getTag(this, 'ExposureBiasValue') ? `${EXIF.getTag(this, 'ExposureBiasValue')} EV` : 'Not available',
                            whiteBalance: EXIF.getTag(this, 'WhiteBalance') === 1 ? 'Auto' : 'Manual',
                            meteringMode: EXIF.getTag(this, 'MeteringMode') ? EXIF.getTag(this, 'MeteringMode') : 'Not available',
                            focusMode: EXIF.getTag(this, 'FocusMode') ? EXIF.getTag(this, 'FocusMode') : 'Not available',
                            cameraMake: EXIF.getTag(this, 'Make') || 'Web Camera',
                            cameraModel: EXIF.getTag(this, 'Model') || 'Browser Camera',
                            dateTaken: EXIF.getTag(this, 'DateTime') || new Date().toISOString(),
                            flash: EXIF.getTag(this, 'Flash') ? 'Used' : 'Not used',
                            lensModel: EXIF.getTag(this, 'LensModel') || 'Not available',
                        };

                        resolve({ ...basicMetadata, ...exifData });
                    });
                };
                img.src = URL.createObjectURL(file);
            });
        }

        async function analyzeCapturedPhoto() {
            if (!capturedPhotoData) {
                alert('No captured photo available. Please capture a photo first.');
                return;
            }

            try {
                const file = new File([capturedPhotoData], 'captured-photo.jpg', { type: 'image/jpeg' });
                const metadata = await extractImageMetadata(file);
                const imageAnalysis = await analyzeImageProperties(capturedPhotoData);
                
                const analysis = {
                    technical: {
                        resolution: metadata.resolution,
                        aspectRatio: metadata.aspectRatio,
                        megapixels: metadata.megapixels,
                        fileSize: metadata.fileSize,
                        fileType: metadata.fileType,
                        fileName: metadata.fileName,
                        lastModified: metadata.lastModified,
                        aperture: metadata.aperture,
                        shutterSpeed: metadata.shutterSpeed,
                        iso: metadata.iso,
                        focalLength: metadata.focalLength,
                        exposureCompensation: metadata.exposureCompensation,
                        whiteBalance: metadata.whiteBalance,
                        meteringMode: metadata.meteringMode,
                        focusMode: metadata.focusMode,
                        cameraMake: metadata.cameraMake,
                        cameraModel: metadata.cameraModel,
                        dateTaken: metadata.dateTaken,
                        flash: metadata.flash,
                        lensModel: metadata.lensModel,
                    },
                    lighting: {
                        condition: imageAnalysis.lightingCondition,
                        quality: imageAnalysis.lightingQuality,
                        colorTemp: imageAnalysis.colorTemperature,
                        brightness: imageAnalysis.brightness,
                        contrast: imageAnalysis.contrast,
                    },
                    composition: {
                        ruleOfThirds: imageAnalysis.compositionScore > 70 ? 'Good composition' : 'Consider rule of thirds',
                        depth: imageAnalysis.hasDepth ? 'Good depth perception' : 'Try adding depth',
                        framing: imageAnalysis.compositionScore > 75 ? 'Well-framed' : 'Consider better framing',
                        balance: imageAnalysis.compositionScore > 70 ? 'Good balance' : 'Try improving balance',
                    },
                    settings: {
                        current: `Resolution: ${metadata.resolution}, File Size: ${metadata.fileSize}, Quality: ${imageAnalysis.overallQuality}`,
                        recommended: imageAnalysis.recommendations.join(', '),
                        reasoning: `Based on analysis of ${metadata.resolution} image with ${imageAnalysis.overallQuality} quality`,
                    },
                    tips: imageAnalysis.specificTips,
                    overall: {
                        score: imageAnalysis.overallScore,
                        genre: imageAnalysis.detectedGenre,
                        strengths: imageAnalysis.strengths,
                        improvements: imageAnalysis.improvements,
                        timestamp: new Date().toISOString(),
                    },
                };
                
                updateAnalysisPanel(analysis);
                alert(`Analysis complete! Score: ${imageAnalysis.overallScore}/100`);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Failed to analyze photo. Please try again.');
            }
        }

        async function analyzeUploadedImage() {
            if (!uploadedImageData) {
                alert('Please upload an image first.');
                return;
            }

            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) return;

                const metadata = await extractImageMetadata(file);
                const imageAnalysis = await analyzeImageProperties(file);
                
                const analysis = {
                    technical: {
                        resolution: metadata.resolution,
                        aspectRatio: metadata.aspectRatio,
                        megapixels: metadata.megapixels,
                        fileSize: metadata.fileSize,
                        fileType: metadata.fileType,
                        fileName: metadata.fileName,
                        lastModified: metadata.lastModified,
                        aperture: metadata.aperture,
                        shutterSpeed: metadata.shutterSpeed,
                        iso: metadata.iso,
                        focalLength: metadata.focalLength,
                        exposureCompensation: metadata.exposureCompensation,
                        whiteBalance: metadata.whiteBalance,
                        meteringMode: metadata.meteringMode,
                        focusMode: metadata.focusMode,
                        cameraMake: metadata.cameraMake,
                        cameraModel: metadata.cameraModel,
                        dateTaken: metadata.dateTaken,
                        flash: metadata.flash,
                        lensModel: metadata.lensModel,
                    },
                    lighting: {
                        condition: imageAnalysis.lightingCondition,
                        quality: imageAnalysis.lightingQuality,
                        colorTemp: imageAnalysis.colorTemperature,
                        brightness: imageAnalysis.brightness,
                        contrast: imageAnalysis.contrast,
                    },
                    composition: {
                        ruleOfThirds: imageAnalysis.compositionScore > 70 ? 'Good composition' : 'Consider rule of thirds',
                        depth: imageAnalysis.hasDepth ? 'Good depth perception' : 'Try adding depth',
                        framing: imageAnalysis.compositionScore > 75 ? 'Well-framed' : 'Consider better framing',
                        balance: imageAnalysis.compositionScore > 70 ? 'Good balance' : 'Try improving balance',
                    },
                    settings: {
                        current: `Resolution: ${metadata.resolution}, File Size: ${metadata.fileSize}, Quality: ${imageAnalysis.overallQuality}`,
                        recommended: imageAnalysis.recommendations.join(', '),
                        reasoning: `Based on analysis of ${metadata.resolution} image with ${imageAnalysis.overallQuality} quality`,
                    },
                    tips: imageAnalysis.specificTips,
                    overall: {
                        score: imageAnalysis.overallScore,
                        genre: imageAnalysis.detectedGenre,
                        strengths: imageAnalysis.strengths,
                        improvements: imageAnalysis.improvements,
                        timestamp: new Date().toISOString(),
                    },
                };
                
                updateAnalysisPanel(analysis);
                alert(`Analysis complete! Score: ${imageAnalysis.overallScore}/100`);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Failed to analyze image. Please try again.');
            }
        }

        function analyzeScene() {
            const mockAnalysis = {
                technical: {
                    resolution: '1280x720',
                    aspectRatio: '1.78',
                    megapixels: '0.9',
                    fileSize: 'Unknown',
                    fileType: 'Live Camera Feed',
                    fileName: 'Live Feed',
                    lastModified: new Date().toLocaleString(),
                    aperture: 'Not available',
                    shutterSpeed: 'Not available',
                    iso: 'Not available',
                    focalLength: 'Not available',
                    exposureCompensation: 'Not available',
                    whiteBalance: 'Auto',
                    meteringMode: 'Not available',
                    focusMode: 'Auto',
                    cameraMake: 'Web Camera',
                    cameraModel: 'Browser Camera',
                    dateTaken: new Date().toISOString(),
                    flash: 'Not used',
                    lensModel: 'Not available',
                },
                lighting: {
                    condition: 'Live scene analysis',
                    quality: 'Good',
                    colorTemp: 'Daylight (5500K)',
                    brightness: 'Balanced',
                    contrast: 'Good',
                },
                composition: {
                    ruleOfThirds: 'Consider applying rule of thirds for better composition',
                    depth: 'Good depth of field',
                    framing: 'Well-framed subject',
                    balance: 'Good balance',
                },
                settings: {
                    current: 'Live camera feed - 1280x720 resolution',
                    recommended: 'Consider adjusting exposure for optimal results',
                    reasoning: 'Based on live scene analysis',
                },
                tips: [
                    'Try different angles for more dynamic shots',
                    'Consider using composition overlays',
                    'Experiment with different lighting conditions',
                ],
                overall: {
                    score: 75,
                    genre: 'Live Photography',
                    strengths: ['Good technical quality', 'Clear image capture', 'Proper exposure'],
                    improvements: ['Try different compositions', 'Experiment with angles', 'Consider lighting variations'],
                    timestamp: new Date().toISOString(),
                },
            };
            
            updateAnalysisPanel(mockAnalysis);
            alert('Live scene analysis complete! Check the analysis panel below.');
        }

        function updateAnalysisPanel(analysis) {
            analysisContent.innerHTML = `
                <div class="overall-score">
                    <div class="score-number">${analysis.overall.score}</div>
                    <div class="score-label">Overall Score / 100</div>
                    <div style="margin-top: 8px; font-size: 14px; opacity: 0.8;">${analysis.overall.genre}</div>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-section">
                        <div class="section-title">üìä Technical Details</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Resolution</div>
                            <div class="analysis-value">${analysis.technical.resolution}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Aspect Ratio</div>
                            <div class="analysis-value">${analysis.technical.aspectRatio}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Megapixels</div>
                            <div class="analysis-value">${analysis.technical.megapixels} MP</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">File Size</div>
                            <div class="analysis-value">${analysis.technical.fileSize}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Camera</div>
                            <div class="analysis-value">${analysis.technical.cameraMake} ${analysis.technical.cameraModel}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Aperture</div>
                            <div class="analysis-value">${analysis.technical.aperture}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Shutter Speed</div>
                            <div class="analysis-value">${analysis.technical.shutterSpeed}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">ISO</div>
                            <div class="analysis-value">${analysis.technical.iso}</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">üí° Lighting Analysis</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Condition</div>
                            <div class="analysis-value">${analysis.lighting.condition}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Quality</div>
                            <div class="analysis-value">${analysis.lighting.quality}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Color Temperature</div>
                            <div class="analysis-value">${analysis.lighting.colorTemp}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Brightness</div>
                            <div class="analysis-value">${analysis.lighting.brightness}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Contrast</div>
                            <div class="analysis-value">${analysis.lighting.contrast}</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">üé® Composition</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Rule of Thirds</div>
                            <div class="analysis-value">${analysis.composition.ruleOfThirds}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Depth</div>
                            <div class="analysis-value">${analysis.composition.depth}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Framing</div>
                            <div class="analysis-value">${analysis.composition.framing}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Balance</div>
                            <div class="analysis-value">${analysis.composition.balance}</div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <div class="section-title">‚öôÔ∏è Settings</div>
                        <div class="analysis-item">
                            <div class="analysis-label">Current</div>
                            <div class="analysis-value">${analysis.settings.current}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Recommended</div>
                            <div class="analysis-value">${analysis.settings.recommended}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Reasoning</div>
                            <div class="analysis-value">${analysis.settings.reasoning}</div>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <div class="section-title">üí° Photography Tips</div>
                    <ul class="tips-list">
                        ${analysis.tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>

                <div class="analysis-section">
                    <div class="section-title">‚úÖ Strengths</div>
                    <ul class="tips-list">
                        ${analysis.overall.strengths.map(strength => `<li>${strength}</li>`).join('')}
                    </ul>
                </div>

                <div class="analysis-section">
                    <div class="section-title">üîß Improvements</div>
                    <ul class="tips-list">
                        ${analysis.overall.improvements.map(improvement => `<li>${improvement}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            analysisPanel.style.display = 'block';
        }

        // Event Listeners
        document.getElementById('cameraModeBtn').addEventListener('click', () => setMode('camera'));
        document.getElementById('uploadModeBtn').addEventListener('click', () => setMode('upload'));
        document.getElementById('compositionBtn').addEventListener('click', toggleComposition);
        document.getElementById('startCameraBtn').addEventListener('click', startCamera);
        document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
        document.getElementById('captureBtn').addEventListener('click', capturePhoto);
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            if (currentMode === 'camera') {
                analyzeScene();
            } else {
                analyzeUploadedImage();
            }
        });
        document.getElementById('analyzeLastPhotoBtn').addEventListener('click', analyzeCapturedPhoto);
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // Initialize
        updateDebugInfo();
    </script>
</body>
</html>
